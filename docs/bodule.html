<!DOCTYPE html>

<html>
<head>
  <title>bodule.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>bodule.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>BODULE-ENGINE</p>
<p><strong>BODULE-ENGINE</strong> is a runtime, in which all of the wrapper <code>node</code> module are running.
it&#39;s a part of  solution for packing <code>node</code> module to browser.</p>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Seed runtime</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__modules = {}

<span class="function"><span class="title">__require</span></span> = (id)-&gt;
    module = __modules[id]
    module.exports <span class="keyword">or</span> module.exports = __use module.factory

<span class="function"><span class="title">__define</span></span> = (id, factory)-&gt;
    __modules[id] =
        id: id
        factory:factory

<span class="function"><span class="title">__use</span></span> = (factory)-&gt;
    module = {}
    exports = module.exports = {}
    factory __require, exports, module
    module.exports</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'util'</span>, (require, exports, module)-&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Script loader util</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    head = document.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>]
    <span class="function"><span class="title">loadScript</span></span> = (id, callback) -&gt;
        node = document.createElement <span class="string">'script'</span>
        node.type = <span class="string">'text/javascript'</span>
        node.async = <span class="literal">true</span>
        node.src = <span class="string">"<span class="subst">#{id}</span>.js"</span>
        node.<span class="function"><span class="title">onload</span></span> = -&gt;
            callback()
            head.removeChild node
             
        head.appendChild node</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Guid</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    i = <span class="number">0</span>
    <span class="function"><span class="title">guid</span></span> = -&gt;
        ++i

    exports.loadScript = loadScript
    exports.guid = guid</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'path'</span>, (require, exports, module)-&gt;

    DIRNAME_REG = <span class="regexp">/[^?#]*\//</span>
    ROOT_DIR_REG = <span class="regexp">/^.*?\/\/.*?\//</span>
    MORE_THAN_TWO_SLASH_REG = <span class="regexp">/([^:]\/)(\/{1,})/</span>
    DOT_REG = <span class="regexp">/\/\.\//</span>
    DOUBLE_DOT_REG = <span class="regexp">/\/[^/]+\/\.\.\//</span>


    <span class="function"><span class="title">dirname</span></span> = (path)-&gt;
        path.match(DIRNAME_REG)[<span class="number">0</span>]

    <span class="function"><span class="title">resolve</span></span> = (from, to)-&gt;
        fisrt = to.charAt <span class="number">0</span>
        <span class="keyword">if</span> fisrt <span class="keyword">is</span> <span class="string">'.'</span>
            path = dirname(from) + to
        <span class="keyword">if</span> fisrt <span class="keyword">is</span> <span class="string">'/'</span>
            match = from.match ROOT_DIR_REG
            path = match[<span class="number">0</span>] + to.substring(<span class="number">0</span>)
        path

    <span class="function"><span class="title">normalize</span></span> = (path)-&gt;
        path = path.replace MORE_THAN_TWO_SLASH_REG, <span class="string">'$1'</span> <span class="keyword">while</span> path.match MORE_THAN_TWO_SLASH_REG
        path = path.replace DOT_REG, <span class="string">'/'</span> <span class="keyword">while</span> path.match DOT_REG
        path = path.replace DOUBLE_DOT_REG, <span class="string">'/'</span> <span class="keyword">while</span> path.match DOUBLE_DOT_REG
        path

    exports.dirname = dirname
    exports.resolve = resolve
    exports.normalize = normalize</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>EventEmmiter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'emmiter'</span>, (require, exports, module)-&gt;

    <span class="class"><span class="keyword">class</span> <span class="title">EventEmmiter</span></span>
        constructor: -&gt;
            <span class="property">@__listeners</span> = {}
        listeners: (event)-&gt;
            listeners = <span class="property">@__listeners</span>
            listeners[event] <span class="keyword">or</span> listeners[event] = []
        <span class="literal">on</span>: (event, listener)-&gt;
            <span class="property">@listeners</span>(event).push listener
        emit: (event)-&gt;
            args = []
            listeners = <span class="property">@listeners</span>(event).slice()
            <span class="keyword">if</span> arguments.length &gt; <span class="number">1</span>
                args = Array::slice arguments
                args.shift()
            <span class="keyword">for</span> listener <span class="keyword">in</span> listeners
                listener.apply @, args

    module.exports = EventEmmiter</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'module'</span>, (require, exports, module)-&gt;

    util = require <span class="string">'util'</span>
    EventEmmiter = require <span class="string">'emmiter'</span>
    path = require <span class="string">'path'</span>

    STATUS = 
        INIT:       <span class="number">0</span>
        FETCHING:   <span class="number">1</span>
        SAVED:      <span class="number">2</span>
        LOADING:    <span class="number">3</span>
        LOADED:     <span class="number">4</span>
        EXECUTING:  <span class="number">5</span>
        EXECUTED:   <span class="number">6</span>

    moduleData = <span class="literal">null</span>

    <span class="class"><span class="keyword">class</span> <span class="title">Module</span> <span class="keyword">extends</span> <span class="title">EventEmmiter</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Static</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="property">@modules</span> = {}
        <span class="property">@get</span>: (id, deps, factory)-&gt;
            module = <span class="property">@modules</span>[id]
            <span class="keyword">if</span> module
                module.deps = deps.map (dep)-&gt;
                    dep = path.resolve id, dep
                    dep = path.normalize dep
                module.factory = factory
            <span class="keyword">else</span>
                module = <span class="keyword">new</span> Module id, deps, factory
            <span class="property">@modules</span>[id] = module
        <span class="property">@define</span>: (id, deps, factory)-&gt;
            moduleData =
                deps: deps,
                factory: factory
        <span class="property">@require</span>: (id)=&gt;
            module = <span class="property">@modules</span>[id]
            module.exports <span class="keyword">or</span> module.exports = <span class="property">@use</span> module
        <span class="property">@use</span>: (module)-&gt;
            module.exec()
            module.exports
        <span class="property">@save</span>: (id, deps, factory)-&gt;
            module = <span class="property">@get</span> id, deps, factory
            module.state = STATUS.SAVED
            module.loadDeps()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Instance</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        constructor: (<span class="property">@id</span>, <span class="property">@deps</span>=[], <span class="property">@factory</span>)-&gt;
            <span class="property">@deps</span> = <span class="property">@deps</span>.map (dep)=&gt;
                dep = path.resolve <span class="property">@id</span>, dep
                dep = path.normalize dep
            <span class="property">@exports</span> = <span class="literal">null</span>
            <span class="property">@state</span> = STATUS.INIT
            <span class="keyword">super</span>
        exec: -&gt;
            <span class="function"><span class="title">__require</span></span> = (id)=&gt;
                id = path.resolve <span class="property">@id</span>, id
                id = path.normalize id
                Module.require id
            __module = {}
            __exports = __module.exports = {}
            <span class="property">@factory</span>(__require, __exports, __module)
            <span class="property">@exports</span> = __module.exports
        loadDeps: ()-&gt;
            depModules = []
            <span class="keyword">if</span> <span class="property">@state</span> &gt; STATUS.LOADING
                <span class="keyword">return</span>
            <span class="property">@state</span> = STATUS.LOADING

            <span class="keyword">for</span> dep <span class="keyword">in</span> <span class="property">@deps</span>
                module = Module.get dep
                module.<span class="literal">on</span> <span class="string">'loaded'</span>, <span class="property">@isDepsLoaded</span>
                depModules.push module
            <span class="property">@depModules</span> = depModules
            <span class="property">@isDepsLoaded</span>()

            <span class="keyword">for</span> module <span class="keyword">in</span> depModules
                <span class="keyword">if</span> module.state &lt; STATUS.FETCHING
                    module.fetch()
                <span class="keyword">else</span> <span class="keyword">if</span> moudle.state <span class="keyword">is</span> STATUS.SAVED
                    module.loadDeps()
        isDepsLoaded: =&gt;
            loaded = <span class="literal">true</span>
            <span class="keyword">for</span> module <span class="keyword">in</span> <span class="property">@depModules</span>
                <span class="keyword">if</span> module.state &lt; STATUS.LOADED
                    loaded = <span class="literal">false</span>
            <span class="keyword">if</span> loaded
                <span class="property">@state</span> = STATUS.LOADED
                <span class="property">@emit</span> <span class="string">'loaded'</span>
        fetch: -&gt;
            <span class="keyword">if</span> <span class="property">@state</span> &lt; STATUS.FETCHING
                util.loadScript <span class="property">@id</span>, =&gt;
                    Module.save <span class="property">@id</span>, moduleData.deps, moduleData.factory
                <span class="keyword">return</span>
            <span class="property">@state</span> = STATUS.FETCHING

    module.exports = Module</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Config</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'config'</span>, (require, exports, module)-&gt;
    path = require <span class="string">'path'</span>
    config =
        cwd: path.dirname location.href

    exports.<span class="function"><span class="title">config</span></span> = (conf)-&gt;
        <span class="keyword">if</span> arguments.length <span class="keyword">is</span> <span class="number">0</span>
            config
        <span class="keyword">else</span>
            <span class="keyword">for</span> key, value <span class="keyword">of</span> conf
                config[key] = value
            config</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Bodule</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__define <span class="string">'bodule'</span>, (require, exports, module)-&gt;

    Module = require <span class="string">'module'</span>
    util  = require <span class="string">'util'</span>
    path = require <span class="string">'path'</span>
    config = require <span class="string">'config'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Bodule API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    Bodule =
        use: (deps, factory)-&gt;
            id = path.resolve config.config().cwd, <span class="string">"./_use_<span class="subst">#{util.guid()}</span>"</span>
            id = path.normalize id
            module = Module.get id, deps, factory
            module.<span class="literal">on</span> <span class="string">'loaded'</span>, -&gt;
                Module.use module
            module.loadDeps()
        define: (id, deps, factory)-&gt;
            Module.define id, deps, factory
        Module: Module

    module.exports = Bodule</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>__use (require)-&gt;

    Bodule = require <span class="string">'bodule'</span>

    window.Bodule = Bodule
    window.define = ()-&gt;
        Bodule.define.apply(Bodule, arguments)</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
